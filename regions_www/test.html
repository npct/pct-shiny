<!DOCTYPE html>
<html>
<head>

<title>Local Authority - Propensity of Cycle</title>

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="shortcut icon" href="www/icons/favicon.ico">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>


<link rel="stylesheet" href="https://unpkg.com/leaflet-easybutton@2.0.0/src/easy-button.css">
<script src="https://unpkg.com/leaflet-easybutton@2.0.0/src/easy-button.js"></script>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css"/>

<link rel="stylesheet" href="www/la-map-resources/leaflet-search.css" />

<script type="text/javascript" src="www/la-map-resources/leaflet-control-credits.js"></script>
<link rel="stylesheet" href="www/la-map-resources/leaflet-control-credits.css" />

<script type="text/javascript" src="www/la-map-resources/L.Control.SlideMenu.js"></script>
<link rel="stylesheet" href="www/la-map-resources/L.Control.SlideMenu.css" />


<style>
 body {
  padding: 0;
  margin: 0;
  }
  html, body, #map {
    height: 100%;
    width: 100%;
}
.info-box {
  padding: 6px 8px;
  font: 14px/16px Arial, Helvetica, sans-serif;
  background: white;
  background: rgba(255,255,255,0.8);
  box-shadow: 0 0 15px rgba(0,0,0,0.2);
  border-radius: 5px;
}

.leaflet-control.cycle-to-work {
  width: 300px;
  height: 85px;
}

.info b {
  margin: 0 0 5px;
  color: #777;
}
.text-muted {
  color: #777;
}
.legend {
  text-align: left;
  line-height: 18px;
  color: #555;
}

.legend i {
  width: 18px;
  height: 18px;
  float: left;
  margin-right: 8px;
  opacity: 0.7;
}

br.clear {
  clear: both;
}

.leaflet-control-layers label {
  margin-bottom: initial;
}
</style>

</head>
<body>

<div id='map'></div>
<script type="text/javascript" src="www/front_page/school/pct_regions_lowres_scenario_school.js"></script>
<script type="text/javascript" src="www/front_page/commute/pct_regions_lowres_scenario_commute.js"></script>

<script src="www/la-map-resources/leaflet-search.js"></script>
<script src="www/assets/google-analytics.js"></script>
<link rel="stylesheet" href = "www/la-map-resources/leaflet-search.src.css">

<script type="text/javascript">


    var selectedLayerName = "commute";
    var selectedVariable = "bicycle_perc";
    var featureGroup = null;

   var default_commute_layer = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
          maxZoom: 18,
          attribution: '<a href="//leafletjs.com" target = "_blank">Leaflet</a> | ' +
          'Map data &copy; <a href="//openstreetmap.org" target = "_blank">OpenStreetMap</a> contributors | ' +
          '<a href="//creativecommons.org/licenses/by-sa/2.0/" target = "_blank">CC-BY-SA</a>'
    });
    var default_school_layer = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
          maxZoom: 18,
          attribution: '<a href="//leafletjs.com" target = "_blank">Leaflet</a> | ' +
          'Map data &copy; <a href="//openstreetmap.org" target = "_blank">OpenStreetMap</a> contributors | ' +
          '<a href="//creativecommons.org/licenses/by-sa/2.0/" target = "_blank">CC-BY-SA</a>'
    });

    var baseLayers = {
      "Commute": default_commute_layer,
      "School" : default_school_layer
    };

        // initialize the map
    /*var map = L.map('map', {
        center: [53, -0.4],
        zoom: 6
    });*/

    var map = L.map('map');

    map.on('baselayerchange', layerUpdate);

    map.setView([53, -0.4], 6);

    var default_scenario = L.tileLayer('');

    var scenario_layers = {
      "Census 2011": default_scenario,
      "Government Target": L.tileLayer(''),
      "Gender Equality": L.tileLayer(''),
      "Go Dutch": L.tileLayer(''),
      "Ebikes": L.tileLayer('')
    };

  // control that shows region info on hover
    var info = L.control();

    info.onAdd = function (map) {
      this._div = L.DomUtil.create('div', 'info-box cycle-to-work');
      this.update();
      return this._div;
    };

    // Armin's solution to a fixed decimal places
    // taken from a stackoverflow thread:
    // http://stackoverflow.com/questions/1726630/formatting-a-number-with-exactly-two-decimals-in-javascript
    // source: https://gist.github.com/ArminVieweg/28647e735aa6efaba401
    function sign(num) {
      // IE does not support method sign here
      if (typeof Math.sign === 'undefined') {
        if (num > 0) {
          return 1;
        }
        if (num < 0) {
          return -1;
        }
        return 0;
      }
      return Math.sign(num);
    }

    function precise_round(num, decimals) {
      var t=Math.pow(10, decimals);
      return (Math.round((num * t) + (decimals>0?1:0)*(sign(num) * (10 / Math.pow(100, decimals)))) / t).toFixed(decimals);
    }

    info.scenarioMap = {
      bicycle_perc: "2011 Census",
      govtarget_slc_perc: "Government Target",
      gendereq_slc_perc: "Gender Equality",
      dutch_slc_perc: "Go Dutch",
      ebike_slc_perc: "Ebike"
    };

    info.update = function (props, scenario) {

      var regionText;
      if(scenario !== undefined && props) {
        regionText = '<b>' + capitalize(props.region_name) + '</b><br />' + precise_round(props[scenario], 1) + '  % in ' + info.scenarioMap[scenario];
      } else {
        regionText = 'Hover over a region';
      }

      if (selectedLayerName == "Commute") {
          this._div.innerHTML = '<h4>Cycling to work</h4>' + regionText;
      }else if (selectedLayerName == "School") {
          this._div.innerHTML = '<h4>Cycling to school</h4>' + regionText;
      }
    };

    // Capitalize all words in a region except 'and' and 'of'
    function capitalize(s){
      s = s.replace(/-/g, ' ');
      s = s.toLowerCase().replace( /\b./g, function(a){ return a.toUpperCase(); } );
      s = s.replace('And', 'and');
      s = s.replace('Of', 'of');
      return s;
    }

    info.addTo(map);

    L.control.layers(baseLayers, null, {collapsed: false}, {position: 'topleft'}).addTo(map);

    baseLayers["Commute"].addTo(map);

    L.control.layers(scenario_layers, null, {collapsed: false}, {position: 'topleft'}).addTo(map);

    scenario_layers["Census 2011"].addTo(map);

    function onMapLoad (e){
      console.log("layer is added" + e.name)
    };


    var polyColor = 'black';
    var polyWeight = 0.5;
    var polyFillOpacity = polyOpacity = 0.8;
    var polyDashArry = '';

    function highlightFeature(property) {
      return function(e) {
        var layer = e.target;

        layer.setStyle({
          weight: 5,
          color: '#666',
          dashArray: '',
          fillOpacity: polyFillOpacity
        });

        if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
          layer.bringToFront();
        }

        info.update(layer.feature.properties, property);
      };
    }

    function resetHighlight(property, feature) {
      return function(e) {
        e.target.setStyle(mapStyle(property)(feature));
        info.update();
      };
    }

    function openRegion(e) {
      window.open(".\/m/?r=" + e.target.feature.properties.region_name, '_top');
    }

    function eachFeature(property) {
      //console.log("onEachFeature " + property)

      return function(feature, layer) {
        layer.on({
          mouseover: highlightFeature(property),
          mouseout: resetHighlight(property, feature),
          click: openRegion
        });
      };
    }

    function mapStyle(property) {
      return function (feature) {
        //console.log("mapStyle " + feature.properties[property])

        return {
          weight: polyWeight,
          //opacity: poly_opacity,
          color: polyColor,
          dashArray: polyDashArry,
          fillOpacity: polyFillOpacity,
          fillColor: getColor(feature.properties[property])
        };
      };
    }


     function layerUpdate (e) {
       //console.log(e)

      if (e.name == "Census 2011")
        selectedVariable = "bicycle_perc"
      else if(e.name == "Government Target")
        selectedVariable = "govtarget_slc_perc"
      else if(e.name == "Gender Equality")
        selectedVariable = "gendereq_slc_perc"
      else if(e.name == "Go Dutch")
        selectedVariable = "dutch_slc_perc"
      else if(e.name == "Ebikes")
        selectedVariable = "ebike_slc_perc"

      if (e.name == "Commute"){
        selectedLayerName = "Commute"
      }
      else if(e.name == "School"){
        selectedLayerName = "School"
      }

      setControls();

      featureGroup ? featureGroup.clearLayers() : "";

      if (selectedLayerName == "School") {
        featureGroup = L.geoJson(school, {
          style: mapStyle(selectedVariable),
          onEachFeature: eachFeature(selectedVariable)
        }).addTo(map);
      }else if (selectedLayerName == "Commute") {
        featureGroup = L.geoJson(commute, {
          style: mapStyle(selectedVariable),
          onEachFeature: eachFeature(selectedVariable)
      }).addTo(map);

      }

    };

    function selectableControl(controlEl, disabled) {
      $(controlEl).attr('disabled', disabled)
      if(disabled) {
        $(controlEl).parent().addClass("text-muted")
      } else {
        $(controlEl).parent().removeClass("text-muted")
      }
    }

    function setControls(){
      // Disable Gender Equality and Ebikes for School Layer
      if (selectedLayerName == "School") {
         // Disable Health and CO2 radio buttons
         $('input:radio[name="leaflet-base-layers"]:not(:checked)').each(function () {
            if ($(this).parent().text().trim() == "Gender Equality" || $(this).parent().text().trim() == "Ebikes"){
              selectableControl(this, true)
            }
        });
       }else{
          $('input:radio[name="leaflet-base-layers"]:not(:checked)').each(function () {
            selectableControl(this, false)
          });
       }

       // Disable school layer for Ebikes and Gender Equality scenarios
      if (selectedLayerName == "Commute" && (selectedVariable == "ebike_slc_perc" || selectedVariable == "gendereq_slc_perc")) {
         $('input:radio[name="leaflet-base-layers"]:not(:checked)').each(function () {
            if ($(this).parent().text().trim() == "School"){
              selectableControl(this, true)
            }
        });
       }

   }

    var legend = L.control({position: 'topleft'});

    function getColor(d) {
      return d >= 40  ? '#4575B4' :
        d >= 30  ? '#74ADD1' :
        d >= 25  ? '#ABD9E9' :
        d >= 20  ? '#C6DBEF' :
        d >= 15  ? '#ffffbf' :
        d >= 10  ? '#FEE090' :
        d >= 7   ? '#FDAE61' :
        d >= 4   ? '#F46D43' :
        d >= 2   ? '#D73027' :
        d >= 0   ? '#A50026' :
        '#313695';

    }

    legend.onAdd = function (map) {

      var div = L.DomUtil.create('div', 'info-box legend'),
        grades = [0, 2, 4, 7, 10, 15, 20, 25, 30, 40],
        bin_labels = ["0-1%",
          "2-3%",
          "4-6%",
          "7-9%",
          "10-14%",
          "15-19%",
          "20-24%",
          "25-29%",
          "30-39%",
          "40%+"],

      labels = [],
      from;
    for (var i = 0; i < grades.length; i++) {
      from = grades[i];
      labels.push(
          '<i style="background:' + getColor(from + 1) + '"></i> ' +
        bin_labels[i]);
    }
    div.innerHTML = labels.join("<br class=\"clear\">");
    return div;
  };

  legend.addTo(map);
  map.whenReady(layerUpdate);

</script>

</body>
</html>
